<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="robots" content="noindex">
    <meta property="csp-nonce" content="">
    
    
    
    
    <title>Writing integration tests  - NHSBSA
</title>

    
    <link href="https://www.nhs.uk/" rel="preconnect">
    <link href="https://assets.nhs.uk/" rel="preconnect" crossorigin>
    
    <link type="font/woff2" href="https://assets.nhs.uk/fonts/FrutigerLTW01-55Roman.woff2" rel="preload" as="font" crossorigin>
    <link type="font/woff2" href="https://assets.nhs.uk/fonts/FrutigerLTW01-65Bold.woff2" rel="preload" as="font" crossorigin>
    

      
      <link rel="shortcut icon" href="/nhsbsa-digital-playbook/favicons/favicon.ico" type="image/x-icon">
      <link rel="apple-touch-icon" href="/nhsbsa-digital-playbook/favicons/apple-touch-icon-180x180.png">
      <link rel="mask-icon" href="/nhsbsa-digital-playbook/favicons/favicon.svg" color="#005eb8">
      <link rel="icon" sizes="192x192" href="/nhsbsa-digital-playbook/favicons/favicon-192x192.png">
      <meta name="msapplication-TileImage" content="/nhsbsa-digital-playbook/favicons/mediumtile-144x144.png">
      <meta name="msapplication-TileColor" content="#005eb8">
      <meta name="msapplication-square70x70logo" content="/nhsbsa-digital-playbook/favicons/smalltile-70x70.png">
      <meta name="msapplication-square150x150logo" content="/nhsbsa-digital-playbook/favicons/mediumtile-150x150.png">
      <meta name="msapplication-wide310x150logo" content="/nhsbsa-digital-playbook/favicons/widetile-310x150.png">
      <meta name="msapplication-square310x310logo" content="/nhsbsa-digital-playbook/favicons/largetile-310x310.png">


<link href="/nhsbsa-digital-playbook/stylesheets/application.css" media="all" rel="stylesheet" type="text/css" >
<meta property="og:title" content="Writing integration tests">
<meta property="og:image" content="/images/opengraph-image.png">
    
    
    <meta property="og:image" content="/assets/images/open-graph.png">
  </head>
  <body class="">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

      <a class="nhsuk-skip-link" href="#main-content">Skip to main content</a>


  


<header class="nhsuk-header" role="banner">
  <div class="nhsuk-width-container nhsuk-header__container nhsuk-width-container-fluid">
    <div class="nhsuk-header__logo nhsuk-header__logo--only"><a class="nhsuk-header__link" href="/" aria-label="NHS homepage">
          <svg class="nhsuk-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 16" height="40" width="100">
    <path class="nhsuk-logo__background" fill="#005eb8" d="M0 0h40v16H0z"></path>
    <path class="nhsuk-logo__text" fill="#fff" d="M3.9 1.5h4.4l2.6 9h.1l1.8-9h3.3l-2.8 13H9l-2.7-9h-.1l-1.8 9H1.1M17.3 1.5h3.6l-1 4.9h4L25 1.5h3.5l-2.7 13h-3.5l1.1-5.6h-4.1l-1.2 5.6h-3.4M37.7 4.4c-.7-.3-1.6-.6-2.9-.6-1.4 0-2.5.2-2.5 1.3 0 1.8 5.1 1.2 5.1 5.1 0 3.6-3.3 4.5-6.4 4.5-1.3 0-2.9-.3-4-.7l.8-2.7c.7.4 2.1.7 3.2.7s2.8-.2 2.8-1.5c0-2.1-5.1-1.3-5.1-5 0-3.4 2.9-4.4 5.8-4.4 1.6 0 3.1.2 4 .6"></path>
  </svg>
      </a>    </div>
    </div>

</header>


      <div class="nhsuk-width-container nhsuk-width-container-fluid">
        <main class="nhsuk-main-wrapper " id="main-content" role="main">
<div class="nhsuk-grid-row">
  <div class="nhsuk-grid-column-full">    <div class="nhsbsa-sticky-nav">
        <h2 class="nhsbsa-sticky-nav__heading">Contents</h2>
        <div class="nhsbsa-sticky-nav__list" >
        <ol><li><a href="#overview">Overview</a></li><li><a href="#maven-testing-plugins-and-their-lifecycles">Maven testing plugins and their lifecycles</a></li><li><a href="#write-an-integration-test">Write an integration test</a></li><li><a href="#gitlab-ci-and-docker">Gitlab-CI and Docker</a></li><li><a href="#linking-with-dns">Linking with DNS</a></li><li><a href="#configuring-with-profiles">Configuring with profiles</a></li><li><a href="#liquibase">Liquibase</a></li><li><a href="#maven-and-liquibase">Maven and Liquibase</a></li><li><a href="#references">References</a></li></ol>
      </div>
    </div>

    <div class="nhsbsa-article-content">
      <div class="nhsuk-back-link nhsuk-back-link-js">
        <a class="nhsuk-back-link__link" href="javascript:history.back()">
          <svg class="nhsuk-icon nhsuk-icon__chevron-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" height="24" width="24">
            <path d="M8.5 12c0-.3.1-.5.3-.7l5-5c.4-.4 1-.4 1.4 0s.4 1 0 1.4L10.9 12l4.3 4.3c.4.4.4 1 0 1.4s-1 .4-1.4 0l-5-5c-.2-.2-.3-.4-.3-.7z"></path>
          </svg>
          Go back</a>
      </div>
      
      <div class="nhsbsa-article-header">
        <h1 class="nhsuk-heading-xl">
          Writing integration tests
        </h1>
        
      </div>
      

<h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview">Overview</a></h2>
<p>This guide explains how to implement and configure Integration Tests using the Maven Failsafe plugin, in a Gitlab-CI build environment. As an example, we use a Postgres Database running in Docker with a schema defined using Liquibase, but other external dependant services could be wired up in a similar fashion.</p>
<h2 id="maven-testing-plugins-and-their-lifecycles" tabindex="-1"><a class="header-anchor" href="#maven-testing-plugins-and-their-lifecycles">Maven testing plugins and their lifecycles</a></h2>
<p>Maven provides two plugins to run tests, each one configured to run in different <a href="http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html" target="_blank" rel="noopener">Maven lifecycle</a> phases:</p>
<ul>
<li><a href="https://maven.apache.org/surefire/maven-surefire-plugin/" target="_blank" rel="noopener">Surefire plugin</a>
<ul>
<li>test phase - run unit tests</li>
</ul>
</li>
<li><a href="https://maven.apache.org/surefire/maven-failsafe-plugin/" target="_blank" rel="noopener">Failsafe plugin</a>
<ul>
<li>pre-integration-test phase - downstream resources/services are setup. E.g. liquibase can be run to instantiate a schema in a database</li>
<li>integration-test phase - run integration tests</li>
<li>post-integration-test phase - downstream resources/services are torn down. E.g. liquibase rollback can be executed to test that rollback has been correctly defined</li>
<li>verify - fail the build according to integration test results</li>
</ul>
</li>
</ul>
<p>The important benefit that failsafe provides is the facility to setup and teardown resources outside of the tests themselves. The post-integration-test phase always runs regardless of integration test failures, which is very useful when cleanup is required.</p>
<p>The maven surefire plugin is configured to run by default. The failsafe plugin is not. You must therefore add the plugin to your pom.</p>
<p><strong>But</strong> first consider, do you always want to run integration tests in your build? If the downstream resource isn’t always going to be available, (e.g. in your dev environment), you might want to put this configuration within a profile. I recommend you define the following section in your pom for the plugin to execute:</p>
<pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profiles</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>it<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-failsafe-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>integration-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>verify<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profiles</span><span class="token punctuation">></span></span></code></pre>
<p>You may now run integration tests by switching on the <code>it</code> profile:</p>
<pre class="language-bash"><code class="language-bash">mvn -Pit clean <span class="token function">install</span></code></pre>
<h2 id="write-an-integration-test" tabindex="-1"><a class="header-anchor" href="#write-an-integration-test">Write an integration test</a></h2>
<p>Now you have the failsafe plugin configured you can write an integration test. I find the easiest test to write is that an Entity is saved.</p>
<p>Given this entity:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span><br><span class="token annotation punctuation">@Data</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span><br><br>    <span class="token annotation punctuation">@Id</span><br>    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span>IDENTITY<span class="token punctuation">)</span><br>    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span><br><br>    <span class="token annotation punctuation">@Version</span><br>    <span class="token keyword">private</span> <span class="token keyword">int</span> version<span class="token punctuation">;</span><br><br>    <span class="token keyword">private</span> <span class="token class-name">String</span> firstName<span class="token punctuation">;</span><br>    <span class="token keyword">private</span> <span class="token class-name">String</span> middleNames<span class="token punctuation">;</span><br>    <span class="token keyword">private</span> <span class="token class-name">String</span> surname<span class="token punctuation">;</span><br><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre>
<p>I can write this test:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><br><span class="token annotation punctuation">@DataJpaTest</span><br><span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace<span class="token operator">=</span><span class="token class-name">Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersonIT</span> <span class="token punctuation">{</span><br><br>    <span class="token annotation punctuation">@Autowired</span><br>    <span class="token keyword">protected</span> <span class="token class-name">TestEntityManager</span> entityManager<span class="token punctuation">;</span><br><br>    <span class="token annotation punctuation">@Autowired</span><br>    <span class="token keyword">protected</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span><br><br>    <span class="token annotation punctuation">@Test</span><br>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>        <span class="token class-name">Person</span> fixture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"last"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        entityManager<span class="token punctuation">.</span><span class="token function">persistAndFlush</span><span class="token punctuation">(</span>fixture<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <br>        <span class="token function">assertThat</span><span class="token punctuation">(</span><span class="token class-name">JdbcTestUtils</span><span class="token punctuation">.</span><span class="token function">countRowsInTable</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">,</span> <span class="token string">"person"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>This should run during the integration-test phase in maven:</p>
<pre class="language-bash"><code class="language-bash">mvn -Pit clean <span class="token function">install</span></code></pre>
<p>Note that this would only work if we used an embedded H2 database. As its so easy to run a PostgreSQL instance in Docker, we may as well test against the real thing.</p>
<h2 id="gitlab-ci-and-docker" tabindex="-1"><a class="header-anchor" href="#gitlab-ci-and-docker">Gitlab-CI and Docker</a></h2>
<p>Gitlab-CI runs by default within a Docker container. This allows us to add downstream services as other Docker containers with network access between our tests and the services. In our case, we’re going to run Postgres as a service within Gitlab-CI.</p>
<p>The following code block is a snippet of configuration from a <code>gitlab-ci.yml</code> file:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">Verify Feature</span><span class="token punctuation">:</span><br>  <span class="token key atrule">stage</span><span class="token punctuation">:</span> Build<br>  <span class="token key atrule">services</span><span class="token punctuation">:</span><br>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dps<span class="token punctuation">-</span>nexus.service.nhsbsa<span class="token punctuation">:</span>8444/nhsbsa/postgres<span class="token punctuation">:</span><span class="token number">9.6</span></code></pre>
<p>Here we have configured a dependant service of Postgres that is retrieved from the NHS BSA’s own Docker repository (Nexus). This build will set us up with standard user accounts that we’ll need to access the database and apply schema changes using liquibase (see below).</p>
<p>But, you may choose to use a different Docker image with a pre-populated schema to suit your needs. Here are some examples:</p>
<ul>
<li>CRS: <code>dps-nexus.service.nhsbsa:8444/crs/crs-db</code></li>
<li>PPC: <code>dps-nexus.service.nhsbsa:8444/ppc/ppc-db</code></li>
<li>EIBSS: <code>dps-nexus.service.nhsbsa:8444/eibss/eibss-db</code></li>
</ul>
<h2 id="linking-with-dns" tabindex="-1"><a class="header-anchor" href="#linking-with-dns">Linking with DNS</a></h2>
<p>When Gitlab-CI runs its docker containers, it will expose a simple DNS lookup to the service hostname, using a naming convention based on the Docker image name. We can use this hostname within our test configuration.</p>
<p>For instance, in this snippet, we configured access to the postgres service declared above:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span><br>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span><br>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>postgresql<span class="token punctuation">:</span>//dps<span class="token punctuation">-</span>nexus.service.nhsbsa__nhsbsa__postgres<span class="token punctuation">:</span>5432/lis_pgdb</code></pre>
<h2 id="configuring-with-profiles" tabindex="-1"><a class="header-anchor" href="#configuring-with-profiles">Configuring with profiles</a></h2>
<p>So we have a running database, and our tests are configured to use the hostname Gitlab-CI will provide, but we only want to use this configuration when running in Gitlab.</p>
<p>The answer is profiles: Maven profiles and Spring profiles. The steps are:</p>
<ul>
<li>Configure the test based on active Spring profile<br>
Spring Boot tests will pick up configuration based on a naming convention (item 13), which makes it simple to add the configuration listing above to your test/resources folder using the name: application-gitlabci.yml</li>
<li>Activate a Spring profile from a Maven profile<br>
Now that a Spring profile will activate the Gitlab-CI specific configuration, we need to activate that profile when Maven runs its tests on Gitlab-CI.</li>
</ul>
<p>First, add this to your pom.xml:</p>
<pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profiles</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>gitlabci<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginManagement</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-surefire-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>systemPropertyVariables</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.profiles.active</span><span class="token punctuation">></span></span>gitlabci<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.profiles.active</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>systemPropertyVariables</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-failsafe-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>systemPropertyVariables</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.profiles.active</span><span class="token punctuation">></span></span>gitlabci<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.profiles.active</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>systemPropertyVariables</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginManagement</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profiles</span><span class="token punctuation">></span></span></code></pre>
<p>And then add this to your <code>gitlab-ci.yml</code>:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">Verify Feature</span><span class="token punctuation">:</span><br><span class="token punctuation">...</span><br>  <span class="token key atrule">services</span><span class="token punctuation">:</span><br>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dps<span class="token punctuation">-</span>nexus.service.nhsbsa<span class="token punctuation">:</span>8444/nhsbsa/postgres<span class="token punctuation">:</span><span class="token number">9.6</span><br>  <span class="token key atrule">script</span><span class="token punctuation">:</span><br>    <span class="token punctuation">-</span> mvn <span class="token punctuation">-</span>e <span class="token punctuation">-</span>B <span class="token punctuation">-</span>Pgitlabci clean install</code></pre>
<p>Note: the mvn command above is incomplete and would need code quality directions adding.</p>
<h2 id="liquibase" tabindex="-1"><a class="header-anchor" href="#liquibase">Liquibase</a></h2>
<p>Why test with Liquibase?<br>
You may be wondering why bother separating integration tests from unit tests. There are two good reasons:</p>
<ul>
<li>Testing against an in-memory database will not catch the edge cases when something works in H2, but not in Postgres. It’s much safer to test against the same DB engine as production.</li>
<li>You can test the liquibase scripts at the same time</li>
</ul>
<p>Try to follow <a href="http://www.liquibase.org/bestpractices.html" target="_blank" rel="noopener">best practice</a> when using Liquibase but in addition:</p>
<ul>
<li>Align the individual versioned changelog files with the pom version</li>
<li>Align the change-sets to the pom version with an incremental number</li>
<li>Use your BSA cipher/LAN ID as the author</li>
</ul>
<p>E.g. for db.changelog-1.0.xml</p>
<pre class="language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>databaseChangeLog</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.liquibase.org/xml/ns/dbchangelog/1.9<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span><br>  <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>changeSet</span> <span class="token attr-name">author</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PATTU<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0-1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>createTable</span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my_table<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>column</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>my_column<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TEXT<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>column</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>createTable</span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>changeSet</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>databaseChangeLog</span><span class="token punctuation">></span></span></code></pre>
<h2 id="maven-and-liquibase" tabindex="-1"><a class="header-anchor" href="#maven-and-liquibase">Maven and Liquibase</a></h2>
<p>Liquibase provides a Maven plugin to allow you to execute Liquibase commands within the build lifecycle. A sample pluginManagement snippet is shown below:</p>
<pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginManagement</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.liquibase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>liquibase-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.5.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>promptOnNonLocalDatabase</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>promptOnNonLocalDatabase</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span><span class="token punctuation">></span></span>org.postgresql.Driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>driver</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.yaml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>snakeyaml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${snakeyaml.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.postgresql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>postgresql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${postgres.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginManagement</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></code></pre>
<blockquote>
<p>Note: plugin dependencies to support YAML based configuration and the Postgres database driver. Your requirements may differ.</p>
</blockquote>
<p>To call the liquibase plugin within the pre-integration-test phase, add the following snippet:</p>
<pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profiles</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>liquibase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.liquibase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>liquibase-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>changeLogFile</span><span class="token punctuation">></span></span>src/main/resources/db/changelog/db.changelog-master.yml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>changeLogFile</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>propertyFile</span><span class="token punctuation">></span></span>src/test/resources/liquibase.properties<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>propertyFile</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>liquibase-update<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>pre-integration-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span><br>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>update<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span><br>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span><br>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span><br>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span><br>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profiles</span><span class="token punctuation">></span></span></code></pre>
<ul>
<li><code>&lt;changeLogFile&gt;</code> specifies the location of the main changelog</li>
<li><code>&lt;propertyFile&gt;</code> specified the location of liquibase.properties.<br>
You can use this to specify properties for local development</li>
</ul>
<p>The <code>gitlab-ci.yml</code> file will override these properties for the pipeline</p>
<h2 id="references" tabindex="-1"><a class="header-anchor" href="#references">References</a></h2>
<ul>
<li><a href="http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html" target="_blank" rel="noopener">Maven plugin lifecycle</a></li>
<li><a href="https://maven.apache.org/surefire/maven-surefire-plugin/" target="_blank" rel="noopener">Maven Surefire plugin</a></li>
<li><a href="https://maven.apache.org/surefire/maven-failsafe-plugin/" target="_blank" rel="noopener">Maven Failsafe plugin</a></li>
<li><a href="http://www.liquibase.org/bestpractices.html" target="_blank" rel="noopener">Liquibase best practices</a></li>
</ul>

      <h2 class="nhsuk-heading-l header-anchor" id="improve-the-playbook">Improve the playbook</h2>
      <p>If you spot anything factually incorrect with this page or have ideas for improvement,
        please share your suggestions.</p>

      <p>Before you start, you will need a <a href="https://github.com/join?source=login" target="_blank" rel="noopener">GitHub account</a>.
      Github is an open forum where we collect feedback.</p>
      
<div class="nhsuk-action-link">
  <a class="nhsuk-action-link__link" href="https://github.com/nhsbsa/nhsbsa-digital-playbook/issues/new?template=playbook-proposal.md&amp;title=Change%20to%20page%20&#39;%2Fdevelopment%2Fdev-tests-integration&#39;%20" target="_blank" rel="noopener">
    <svg class="nhsuk-icon nhsuk-icon__arrow-right-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" width="36" height="36">
      <path d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 2a10 10 0 0 0-9.95 9h11.64L9.74 7.05a1 1 0 0 1 1.41-1.41l5.66 5.65a1 1 0 0 1 0 1.42l-5.66 5.65a1 1 0 0 1-1.41 0 1 1 0 0 1 0-1.41L13.69 13H2.05A10 10 0 1 0 12 2z"></path>
    </svg>
    <span class="nhsuk-action-link__text">Suggest a change to this page</span>
  </a>
</div>


    </div>

      <div class="nhsbsa-article--date">
          <p>
            Published <time datetime="2022-06-30T11:12:59.411Z">30 June 2022</time>
          </p>
      </div>
  </div>
</div>
        </main>
      </div>

      <footer role="contentinfo">
	<div class="nhsuk-footer" id="nhsuk-footer">
		<div class="nhsuk-width-container">			<h2 class="nhsuk-u-visually-hidden">Support links</h2>
			
			<ul class="nhsuk-footer__list">				<li class="nhsuk-footer__list-item"><a class="nhsuk-footer__list-item-link" href="/nhsbsa-digital-playbook/accessibility">Accessibility</a></li>				<li class="nhsuk-footer__list-item"><a class="nhsuk-footer__list-item-link" href="https://www.nhsbsa.nhs.uk/contact-us" target="_blank" rel="noopener">Contact us</a></li>				<li class="nhsuk-footer__list-item"><a class="nhsuk-footer__list-item-link" href="https://github.com/nhsbsa/nhsbsa-digital-playbook" target="_blank" rel="noopener">GitHub</a></li>			</ul>

			<p class="nhsuk-footer__copyright">&copy; Crown copyright</p>
		</div>
	</div>

	<div class="nhsuk-ogl-footer">
		<div class="nhsuk-width-container">
			<p class="nhsuk-ogl-footer--text">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 483.2 195.7" height="17" width="41" focusable="false">
			<path fill="currentColor" d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"></path>
			</svg>
			All content is available under the <a class="nhsuk-footer__list-item-link" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="noopener" target="_blank">Open Government Licence v3.0</a>, except where otherwise stated.
			</p>
		</div>
	</div>
</footer>

    <script src="/nhsbsa-digital-playbook/javascripts/nhsuk.js"></script>
    <script src="/nhsbsa-digital-playbook/javascripts/application.js"></script>
  </body>
</html>
