<!DOCTYPE html><html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Removing sensitive data such as non-revokable secrets or contributor identities from Git">
  <meta name="robots" content="noindex">
  
  <title>
Rewriting Git history - NHSBSA Digital, Data and Technology Playbook - NHSBSA
  </title>

  
  <link href="https://assets.nhs.uk/" rel="preconnect" crossorigin>
  <link type="font/woff2" href="https://assets.nhs.uk/fonts/FrutigerLTW01-55Roman.woff2" rel="preload" as="font" crossorigin>
  <link type="font/woff2" href="https://assets.nhs.uk/fonts/FrutigerLTW01-65Bold.woff2" rel="preload" as="font" crossorigin>

  
  <link rel="shortcut icon" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/favicon.ico?v=68c7f017cfbae676351d5e4c1afc6f07" type="image/x-icon">
  <link rel="apple-touch-icon" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/apple-touch-icon-180x180.png?v=15a5044def063cff84af6f9960f9f2ac">
  <link rel="mask-icon" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/favicon.svg" color="#005eb8">
  <link rel="icon" sizes="192x192" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/favicon-192x192.png?v=43924bfe6c7e0f6c0996ee28ad6a5883">

  <meta name="msapplication-TileImage" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/mediumtile-144x144.png?v=cf49858724925dbcfe5f3fa5c90aee0b">
  <meta name="msapplication-TileColor" content="#005eb8">
  <meta name="msapplication-square70x70logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/smalltile-70x70.png?v=29f75b06cf758e8be6b5646317ff3bff">
  <meta name="msapplication-square150x150logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/mediumtile-150x150.png?v=89688d93af5bdc0778ec7e4c7b443ac2">
  <meta name="msapplication-wide310x150logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/widetile-310x150.png?v=535c3996630d6b6a7250a807d6eec5de">
  <meta name="msapplication-square310x310logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/largetile-310x310.png?v=294742e00ff46e8a003d4de1f2c98be7">

  <meta property="og:url" content="https://nhsbsa.github.io/nhsbsa-digital-playbook/development/coding-git-rewrite-history/">
  <meta property="og:site_name" content="nhsbsa.nhs.uk">
  <meta property="og:description" content="Removing sensitive data such as non-revokable secrets or contributor identities from Git">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_GB">
  <meta property="og:image" content="https://nhsbsa.github.io/nhsbsa-digital-playbook/images/opengraph-image.png?v=b6b84e727630ba3e3df184c646ae3808">
  <meta property="og:title" content="Rewriting Git history - NHSBSA Digital, Data and Technology Playbook - NHSBSA">

  <link href="/nhsbsa-digital-playbook/stylesheets/application.css?v=32b02df6de1d9a459b14ec4550e10b8f" media="all" rel="stylesheet" type="text/css" >

</head>

<body class="">

  <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
  

    <a class="nhsuk-skip-link" href="#main-content">Skip to main content</a>


    


<header class="nhsuk-header nhsuk-header--organisation" role="banner">
  
  <div class="nhsuk-header__container">
    <div class="nhsuk-header__logo nhsuk-header__logo--only">      <a class="nhsuk-header__link" href="/nhsbsa-digital-playbook/" aria-label="Business Services Authority  Digital, Data and Technology playbook homepage">  <svg class="nhsuk-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 16" height="40" width="100">
    <path class="nhsuk-logo__background" fill="#005eb8" d="M0 0h40v16H0z"></path>
    <path class="nhsuk-logo__text" fill="#fff" d="M3.9 1.5h4.4l2.6 9h.1l1.8-9h3.3l-2.8 13H9l-2.7-9h-.1l-1.8 9H1.1M17.3 1.5h3.6l-1 4.9h4L25 1.5h3.5l-2.7 13h-3.5l1.1-5.6h-4.1l-1.2 5.6h-3.4M37.7 4.4c-.7-.3-1.6-.6-2.9-.6-1.4 0-2.5.2-2.5 1.3 0 1.8 5.1 1.2 5.1 5.1 0 3.6-3.3 4.5-6.4 4.5-1.3 0-2.9-.3-4-.7l.8-2.7c.7.4 2.1.7 3.2.7s2.8-.2 2.8-1.5c0-2.1-5.1-1.3-5.1-5 0-3.4 2.9-4.4 5.8-4.4 1.6 0 3.1.2 4 .6"></path>
  </svg>

        <span class="nhsuk-organisation-name">Business Services Authority</span>
<span class="nhsuk-organisation-descriptor">Digital, Data and Technology playbook</span>      </a>    </div>
    </div>
    

</header>

<div class="nhsuk-width-container app-width-container">
    <main class="nhsuk-main-wrapper app-main-wrapper" id="main-content" role="main">
<div class="nhsuk-grid-row">
  <div class="nhsuk-width-container app-width-container">
    <div class="app-pane">
      <div class="app-pane__side-bar">
        <nav class="app-side-nav">
        <h2 class="app-side-nav__heading">Contents</h2>
        <div class="nhsbsa-nav__list">
                <ol>
                    
                    <li><a href="#when-to-rewrite-history">When to rewrite history</a>
            		</li>

                    <li><a href="#assess-the-impact">Assess the impact</a>
            		</li>

                    <li><a href="#raise-an-incident">Raise an incident</a>
            		</li>

                    <li><a href="#skills">Skills</a>
            		</li>

                    <li><a href="#execution-steps">Execution steps</a>
            		</li>
                </ol>
            </div>
        </nav>
      </div>

      <div class="app-pane__main-content">
        <div class="nhsuk-back-link no-js">  <a class="nhsuk-back-link__link" href="javascript:history.back()">
  <svg class="nhsuk-icon nhsuk-icon__chevron-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" height="24" width="24">
    <path d="M8.5 12c0-.3.1-.5.3-.7l5-5c.4-.4 1-.4 1.4 0s.4 1 0 1.4L10.9 12l4.3 4.3c.4.4.4 1 0 1.4s-1 .4-1.4 0l-5-5c-.2-.2-.3-.4-.3-.7z"></path>
  </svg>
  Go back</a>
</div>

      
        <div class="nhsbsa-article-header">
          <h1 class="nhsuk-heading-xl">
            Rewriting Git history
          </h1>
          
        </div>
      

<div class="admonition warning">
<p class="admonition-title">Proceed with caution</p>
<p>Rewriting history will change the Git commit graph and has a high potential to create a mess of a repository. Incorrect or unmanaged use of tools can lead to an inconsistent Git repository which is difficult to recover from. Proceed with caution and follow this guidance to protect your project from unintended consequences.</p>
<p><strong>Consult with your professional lead and security operations before any rewrite activity.</strong></p>
</div>
<p>This guidance does not cover normal development activities such as squashing commits on a topic branch, or rebasing prior to merge. These branches are not shared widely and sensitive data is not involved. Collaborative Git practices should be agreed with your team.</p>
<h2 id="when-to-rewrite-history" tabindex="-1"><a class="header-anchor" href="#when-to-rewrite-history">When to rewrite history</a></h2>
<p>Many secrets can be revoked by deleting the secret and regenerating a new one. Applications must then be reconfigured with the new value. This is the preferred way to deal with secrets in code. The <a href="https://gitlab.com/nhsbsa/platform-services/gitleaks/gitleaks-nhsbsa" target="_blank" rel="noopener">NHSBSA Gitleaks project</a> includes links to the various secrets providers, with documentation on creating and revoking secrets. See our guidance on <a href="../coding-secrets-detection/#ignore-false-positives">ignoring revoked secrets in Gitleaks</a>.</p>
<p>Some sensitive information cannot be revoked, and should be removed from the Git history when open sourcing.</p>
<p>Consider:</p>
<div class="card">
<dl>
<dt>Contributor identity</dt>
<dd>We support code contributors who wish to remain anonymous when working on open source projects.</dd>
<dt>Non-revokable secrets</dt>
<dd>Some secrets cannot be revoked, such as internal IP addresses and URLs.</dd>
<dt>Inappropriate language</dt>
<dd>Inappropriate language should be removed to avoid reputational damage.</dd>
<dt>Personally Identifiable Information (PII)</dt>
<dd>PII other than contributor identity should never be checked into source code repositories.<br>
Before removing PII data from source code, <a href="../../security">raise a security incident</a> with the Information Security team.</dd>
</dl>
</div>
<h2 id="assess-the-impact" tabindex="-1"><a class="header-anchor" href="#assess-the-impact">Assess the impact</a></h2>
<p>Consider all branches, including <code>main</code>, <code>develop</code> and <code>release</code>, in scope of rewrite. These branches are shared widely, especially when published in the open.</p>
<p>Assess who will be impacted by publishing destructive changes, including:</p>
<div class="card">
<dl>
<dt>Team members</dt>
<dd>Team members will be actively working on the codebase, and must be kept up to date at all stages of a rewrite.<br>
Use normal team communication channels.</dd>
<dt>NHSBSA DDaT staff and external suppliers</dt>
<dd>Everyone with access rights to a repository has the potential to clone it.<br>
Use standard DDaT email, Teams, slack channels and professional community networks to publicise rewrite activities.</dd>
<dt>X-Gov collaborators and general public</dt>
<dd>Open sourced projects may have been cloned far and wide.<br>
Consult with the NHSBSA communications team to agree an approach.</dd>
</dl>
</div>
<h2 id="raise-an-incident" tabindex="-1"><a class="header-anchor" href="#raise-an-incident">Raise an incident</a></h2>
<p><a href="../../security">Raise a security incident</a> with the Information Security team when you discover secrets committed to a repository. They will ensure you have documented approval from these stakeholders, prior to any destructive rewrite:</p>
<ul>
<li>Information Governance</li>
<li>Security Operations</li>
<li>Architecture</li>
<li>Software Development</li>
</ul>
<p>If the impact extends to external collaborators and the general public, consult with the Communications team.</p>
<h2 id="skills" tabindex="-1"><a class="header-anchor" href="#skills">Skills</a></h2>
<p>Contributors who rewrite history must have the appropriate skills:</p>
<ul>
<li>Git concepts<br>
Itâ€™s important to understand
<ul>
<li>The Git directed acyclic graph, how commits are immutable and must be replaced.</li>
<li>That branches and annotations must be assigned to the newly created commits and their children.</li>
<li>That a rewritten git repository will diverge from the original clone, and how this can cause damage if merged back into the original.</li>
</ul>
</li>
<li>Git commands<br>
You should be very comfortable with these commands and understand what they do:
<ul>
<li><code>git log</code><br>
A key skill is determining if a rewrite is successful. Git log is invaluable for this, as you can export logs before and after and compare the output.
<ul>
<li><code>--all</code></li>
<li><code>--oneline</code></li>
<li><code>--graph</code></li>
<li><code>--abbrev-commit</code></li>
<li><code>--format</code></li>
<li><code>-sne</code></li>
</ul>
</li>
<li><code>git shortlog</code><br>
Shortlog is use to extract data for authors, in order to anonymise.
<ul>
<li><code>-sne</code></li>
</ul>
</li>
<li><code>git push</code><br>
You must understand how to push the rewritten repository and replace all commits, branches, tags. The remote repository should not contain any orphan commits, or any references pointing to old commits.
<ul>
<li><code>--force</code></li>
<li><code>--tags</code></li>
</ul>
</li>
</ul>
</li>
<li>Git filter-repo<br>
<a href="https://github.com/newren/git-filter-repo" target="_blank" rel="noopener">git-filter-repo</a> is the recommended tool for rewriting Git history. Do not use outdated tools such as BFG or git-filter-branch.<br>
The key commands to cover most cases are:
<ul>
<li><code>--analyze</code></li>
<li><code>--mailmap</code></li>
<li><code>--replace-text</code></li>
</ul>
</li>
<li>Bash scripting<br>
You will write a single script to perform all rewrite steps on a clean clone of the repository.</li>
</ul>
<p>This article provides an in-depth guide to removing secrets from Git history by rewriting history:</p>
<ul>
<li><a href="https://blog.gitguardian.com/rewriting-git-history-cheatsheet/" target="_blank" rel="noopener">Git Clean, Git Remove file from commit - Cheatsheet</a></li>
</ul>
<h2 id="execution-steps" tabindex="-1"><a class="header-anchor" href="#execution-steps">Execution steps</a></h2>
<ul>
<li>Create a <strong>private</strong> subgroup called <code>backup</code><br>
Fork the code repository here for safekeeping. The backup may be deleted at a later date</li>
<li>Create a <strong>private</strong> subgroup called <code>git-rewrite</code>.<br>
Fork the code repository here. This will be used to develop, test and review the rewrite. Rewrites to this repository must be performed as a single, scripted action and pushed only once. Any subsequent rewrites must be performed on fresh forks from the original. This ensures the rewrite is clean and repeatable.</li>
<li>Fork the template project <a href="https://gitlab.com/nhsbsa/Libraries/git-rewrite-scripts" target="_blank" rel="noopener">git-rewrite-scripts</a> under the <code>git-rewrite</code> subgroup<br>
This will contain the scripted actions to rewrite history. It is important to script the actions, so that a peer may review and verify correctness.<br>
The scripted actions and associated resources will contain sensitive data and must be kept private. It will serve as an audit history if required.</li>
<li>Develop the rewrite script and peer review with a Merge Request<br>
See the <a href="https://gitlab.com/nhsbsa/Libraries/git-rewrite-scripts" target="_blank" rel="noopener">template project</a> for guidance on script writing.</li>
<li>Dry run
<ul>
<li>Local development should stop.</li>
<li>Consult with team to ensure all local branches are pushed to the production repository.</li>
<li>Create a fresh fork of the repository in <code>git-rewrite</code> folder.</li>
<li>Rewrites must be performed on a fresh clone of the forked repository</li>
<li>Apply scripted rewrites</li>
<li>Add remote origin as rewrite will remove that relationship</li>
<li>Configure protected branches to allow force push</li>
<li>Force push the repository<br>
<code>git push --all --force</code></li>
<li>Force push the tags<br>
<code>git push --tags --force</code></li>
<li>Configure protected branches to disallow force push</li>
<li>Consult with team to assure all is as expected</li>
</ul>
</li>
<li>Apply the rewrite<br>
Repeat the clone, rewrite, push, review, but this time on the production repository</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">All team members must re-clone from the rewritten remote</p>
<p>Old clones should be discarded. Pulling a rewritten remote into the original can create a mess that is very difficult to recover from.</p>
</div>

        <hr>
        <h2 class="nhsuk-heading-l header-anchor" id="improve-the-playbook">Improve the playbook</h2>
        <p>If you spot anything factually incorrect with this page or have ideas for improvement,
          please share your suggestions.</p>

        <p>Before you start, you will need a <a href="https://github.com/join?source=login" target="_blank" rel="noopener">GitHub account</a>.
        Github is an open forum where we collect feedback.</p>
        
<div class="nhsuk-action-link">
  <a class="nhsuk-action-link__link" href="https://github.com/nhsbsa/nhsbsa-digital-playbook/issues/new?template=playbook-proposal.md&amp;title=Change%20to%20page%20&#39;%2Fdevelopment%2Fcoding-git-rewrite-history&#39;%20" target="_blank" rel="noopener">
    <svg class="nhsuk-icon nhsuk-icon__arrow-right-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" width="36" height="36">
      <path d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 2a10 10 0 0 0-9.95 9h11.64L9.74 7.05a1 1 0 0 1 1.41-1.41l5.66 5.65a1 1 0 0 1 0 1.42l-5.66 5.65a1 1 0 0 1-1.41 0 1 1 0 0 1 0-1.41L13.69 13H2.05A10 10 0 1 0 12 2z"></path>
    </svg>
    <span class="nhsuk-action-link__text">Suggest a change to this page</span>
  </a>
</div>



        <div class="nhsbsa-article--date">
    <p class="nhsuk-body-s nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-0">
      Published: <time datetime="2023-05-15T13:56:56.000Z">15 May 2023</time>
    </p>
    <p class="nhsuk-body-s nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-0">
      Last reviewed: <time datetime="2023-05-15T00:00:00.000Z">15 May 2023</time>
    </p>
    <p class="nhsuk-body-s nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-0">
      Next review due: <time datetime="2024-05-15T00:00:00.000Z">15 May 2024</time>
    </p>
</div>


        </div>
      </div>
    </div>
  </div>

    </main>
</div>

    <footer role="contentinfo">
  <div class="nhsuk-footer-container">
    <div class="nhsuk-width-container app-width-container">
      <div class="nhsuk-footer" id="nhsuk-footer">				<h2 class="nhsuk-u-visually-hidden">Support links</h2>
				
				<ul class="nhsuk-footer__list">					<li class="nhsuk-footer__list-item nhsuk-footer-default__list-item"><a class="nhsuk-footer__list-item-link" href="/nhsbsa-digital-playbook/accessibility">Accessibility</a></li>					<li class="nhsuk-footer__list-item nhsuk-footer-default__list-item"><a class="nhsuk-footer__list-item-link" href="https://www.nhsbsa.nhs.uk/contact-us" target="_blank" rel="noopener">Contact us</a></li>					<li class="nhsuk-footer__list-item nhsuk-footer-default__list-item"><a class="nhsuk-footer__list-item-link" href="https://github.com/nhsbsa/nhsbsa-digital-playbook" target="_blank" rel="noopener">GitHub</a></li>				</ul>
        <p class="nhsuk-footer__copyright">&copy; Crown copyright</p>
      </div>
			<div class="nhsuk-ogl-footer">
				<p class="nhsuk-ogl-footer--text">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 483.2 195.7" height="17" width="41" focusable="false">
				<path fill="currentColor" d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"></path>
				</svg>
				All content is available under the <a class="nhsuk-footer__list-item-link" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="noopener" target="_blank">Open Government Licence v3.0</a>, except where otherwise stated.
				</p>
			</div>
    </div>
  </div>
</footer>

    <script src="/nhsbsa-digital-playbook/javascripts/nhsuk.min.js?v=6c54c7949c1f063ec1dc32acd12a7776"></script>
    <script src="/nhsbsa-digital-playbook/javascripts/application.js?v=13016328ce1d4b24d75f5f341c554179"></script>

</body>
</html>
