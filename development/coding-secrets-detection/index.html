<!DOCTYPE html><html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Avoid committing ‘secrets’ such as API keys into source control">
  <meta name="robots" content="noindex">
  
  <title>
Secrets detection - NHSBSA Digital, Data and Technology Playbook - NHSBSA
  </title>

  
  <link href="https://assets.nhs.uk/" rel="preconnect" crossorigin>
  <link type="font/woff2" href="https://assets.nhs.uk/fonts/FrutigerLTW01-55Roman.woff2" rel="preload" as="font" crossorigin>
  <link type="font/woff2" href="https://assets.nhs.uk/fonts/FrutigerLTW01-65Bold.woff2" rel="preload" as="font" crossorigin>

  
  <link rel="shortcut icon" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/apple-touch-icon-180x180.png">
  <link rel="mask-icon" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/favicon.svg" color="#005eb8">
  <link rel="icon" sizes="192x192" href="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/favicon-192x192.png">

  <meta name="msapplication-TileImage" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/mediumtile-144x144.png">
  <meta name="msapplication-TileColor" content="#005eb8">
  <meta name="msapplication-square70x70logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/smalltile-70x70.png">
  <meta name="msapplication-square150x150logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/mediumtile-150x150.png">
  <meta name="msapplication-wide310x150logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/widetile-310x150.png">
  <meta name="msapplication-square310x310logo" content="/nhsbsa-digital-playbook/nhsuk-frontend/assets/favicons/largetile-310x310.png">

  <meta property="og:url" content="https://nhsbsa.github.io/nhsbsa-digital-playbook/development/coding-secrets-detection/">
  <meta property="og:site_name" content="nhsbsa.nhs.uk">
  <meta property="og:description" content="Avoid committing ‘secrets’ such as API keys into source control">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_GB">
  <meta property="og:image" content="https://nhsbsa.github.io/nhsbsa-digital-playbook/images/opengraph-image.png">
  <meta property="og:title" content="Secrets detection - NHSBSA Digital, Data and Technology Playbook - NHSBSA">

  <link href="/nhsbsa-digital-playbook/stylesheets/application.css" media="all" rel="stylesheet" type="text/css" >

</head>

<body class="">

  <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
  

    <a class="nhsuk-skip-link" href="#main-content">Skip to main content</a>


    


<header class="nhsuk-header nhsuk-header--organisation" role="banner">
  <div class="nhsuk-width-container nhsuk-header__container">
    <div class="nhsuk-header__logo nhsuk-header__logo--only">      <a class="nhsuk-header__link" href="/nhsbsa-digital-playbook/" aria-label="Business Services Authority  Digital, Data and Technology playbook homepage">  <svg class="nhsuk-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 16" height="40" width="100">
    <path class="nhsuk-logo__background" fill="#005eb8" d="M0 0h40v16H0z"></path>
    <path class="nhsuk-logo__text" fill="#fff" d="M3.9 1.5h4.4l2.6 9h.1l1.8-9h3.3l-2.8 13H9l-2.7-9h-.1l-1.8 9H1.1M17.3 1.5h3.6l-1 4.9h4L25 1.5h3.5l-2.7 13h-3.5l1.1-5.6h-4.1l-1.2 5.6h-3.4M37.7 4.4c-.7-.3-1.6-.6-2.9-.6-1.4 0-2.5.2-2.5 1.3 0 1.8 5.1 1.2 5.1 5.1 0 3.6-3.3 4.5-6.4 4.5-1.3 0-2.9-.3-4-.7l.8-2.7c.7.4 2.1.7 3.2.7s2.8-.2 2.8-1.5c0-2.1-5.1-1.3-5.1-5 0-3.4 2.9-4.4 5.8-4.4 1.6 0 3.1.2 4 .6"></path>
  </svg>

        <span class="nhsuk-organisation-name">Business Services Authority</span>
<span class="nhsuk-organisation-descriptor">Digital, Data and Technology playbook</span>      </a>    </div>
    </div>

</header>


<div class="nhsuk-width-container app-width-container">
    <main class="nhsuk-main-wrapper app-main-wrapper" id="main-content" role="main">
<div class="nhsuk-grid-row">
  <div class="nhsuk-width-container app-width-container">
    <div class="app-pane">
      <div class="app-pane__side-bar">
        <nav class="app-side-nav">
        <h2 class="app-side-nav__heading">Contents</h2>
        <div class="nhsbsa-nav__list">
                <ol>
                    
                    <li><a href="#what-is-a-secret">What is a secret?</a>
            		</li>

                    <li><a href="#dealing-with-committed-secrets">Dealing with committed secrets</a>
            
                <ol>
                    
                    <li><a href="#revoke-keys-immediately">Revoke keys immediately</a>
            		</li>

                    <li><a href="#rewriting-history">Rewriting history</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#secrets-detection-tooling">Secrets detection tooling</a>
            
                <ol>
                    
                    <li><a href="#add-gitleaks-configuration">Add Gitleaks configuration</a>
            		</li>

                    <li><a href="#add-a-pre-commit-hook">Add a pre-commit hook</a>
            		</li>

                    <li><a href="#configure-gitlab-secrets-detection">Configure Gitlab secrets detection</a>
            		</li>

                    <li><a href="#ignore-false-positives">Ignore false positives</a>
            		</li>
                </ol>
            		</li>
                </ol>
            </div>
        </nav>
      </div>

      <div class="app-pane__main-content">
        <div class="nhsuk-back-link no-js">  <a class="nhsuk-back-link__link" href="javascript:history.back()">
  <svg class="nhsuk-icon nhsuk-icon__chevron-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" height="24" width="24">
    <path d="M8.5 12c0-.3.1-.5.3-.7l5-5c.4-.4 1-.4 1.4 0s.4 1 0 1.4L10.9 12l4.3 4.3c.4.4.4 1 0 1.4s-1 .4-1.4 0l-5-5c-.2-.2-.3-.4-.3-.7z"></path>
  </svg>
  Go back</a>
</div>

      
        <div class="nhsbsa-article-header">
          <h1 class="nhsuk-heading-xl">
            Secrets detection
          </h1>
            <strong class="nhsuk-tag nhsuk-tag--yellow">
  REVIEW
</strong>


        </div>
      

<p>Sensitive information, or ‘secrets’, such as API keys and credentials must not be checked into source control.</p>
<p>Anyone who commits to a repository must be aware of:</p>
<ul>
<li>What constitutes a secret within their service architecture</li>
<li>How to deal with a secret mistakenly committed to a source code repository</li>
<li>How to use secret detection tools effectively</li>
</ul>
<h2 id="what-is-a-secret" tabindex="-1"><a class="header-anchor" href="#what-is-a-secret">What is a secret?</a></h2>
<p>A secret is confidential information that is required to deliver a software solution. It should only be accessible to authorised people under appropriate access control.</p>
<p>We advise all delivery teams to assess their specific build pipeline and deployment architecture to catalogue all the secrets that must be protected.</p>
<p>Consider the following:</p>
<ul>
<li><strong>Build pipeline secrets</strong>
<ul>
<li>SSH keys</li>
<li>Tooling API keys (SonarQube, Saucelabs, etc)</li>
<li>Internal topology<br>
Don’t expose information on internal topology when not necessary:
<ul>
<li>Protocols</li>
<li>Hostnames</li>
<li>Ports</li>
</ul>
</li>
</ul>
</li>
<li><strong>Application runtime secrets</strong>
<ul>
<li>Credentials
<ul>
<li>Usernames</li>
<li>Passwords</li>
<li>API keys</li>
<li>Client certificates</li>
</ul>
</li>
<li>Encryption keys</li>
</ul>
</li>
<li><strong>Personally identifiable data</strong><br>
If you are processing personal data, consider the risk of committing personally identifiable data</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Risk assessment</p>
<p>A sensitive data risk assessment should be recorded in the project documentation site.<br>
It should catalogue service specific secrets, the secret detection rule IDs and remediation steps to take if the secret is ever leaked.</p>
</div>
<hr>
<h2 id="dealing-with-committed-secrets" tabindex="-1"><a class="header-anchor" href="#dealing-with-committed-secrets">Dealing with committed secrets</a></h2>
<p><a href="../../security">Raise a security incident</a> with the Information Security team when you discover secrets committed to a repository. They will engage with the relevant stakeholders to assess the impact, agree remediation actions, and provide an audit trail.</p>
<h3 id="revoke-keys-immediately" tabindex="-1"><a class="header-anchor" href="#revoke-keys-immediately">Revoke keys immediately</a></h3>
<p><strong>Do not wait for a response from Information Security before revoking keys.</strong></p>
<p>From <a href="https://www.gov.uk/government/publications/open-source-guidance/security-considerations-when-coding-in-the-open#assume-accidental-publications-are-compromised" target="_blank" rel="noopener">Government guidance</a></p>
<blockquote>
<p>If you accidentally publish a secret, you must revoke it and immediately provision new keys to the system. Once a secret has been published, you must assume that it is compromised no matter how quickly you are able to remove it as attackers have automated scanning tools that will pick up credential leaks immediately.</p>
<p>This means you must make sure that your system allows for keys and credentials to be changed and rotated easily, and for secrets to be revoked.</p>
</blockquote>
<h3 id="rewriting-history" tabindex="-1"><a class="header-anchor" href="#rewriting-history">Rewriting history</a></h3>
<div class="admonition warning">
<p class="admonition-title">Destructive rewrite of published Git history must follow NHSBSA process</p>
<p>Consult with your professional lead and the security team.</p>
<p>Refer to our <a href="../coding-git-rewrite-history/">guidance on rewriting Git history</a>.</p>
</div>
<hr>
<h2 id="secrets-detection-tooling" tabindex="-1"><a class="header-anchor" href="#secrets-detection-tooling">Secrets detection tooling</a></h2>
<p>Use secrets detection tools to protect against mistaken commits, and to alert if they get pushed to the central repository.</p>
<ul>
<li><a href="https://github.com/zricethezav/gitleaks" target="_blank" rel="noopener">Gitleaks</a> as our secrets detection tool</li>
<li><a href="https://gitlab.com/nhsbsa/platform-services/gitleaks/gitleaks-nhsbsa" target="_blank" rel="noopener">NHSBSA Gitleaks</a> configuration file with verified rules</li>
<li><a href="https://pre-commit.com/" target="_blank" rel="noopener">Pre-commit</a> managed Git hooks to prevent local commits of secrets</li>
<li><a href="https://docs.gitlab.com/ee/user/application_security/secret_detection/" target="_blank" rel="noopener">Gitlab-CI secrets detection</a> to alert in case a local pre-commit git hook has not prevented the commit</li>
</ul>
<h3 id="add-gitleaks-configuration" tabindex="-1"><a class="header-anchor" href="#add-gitleaks-configuration">Add Gitleaks configuration</a></h3>
<p>To use the NHSBSA Gitleaks definitions:</p>
<ul>
<li>Copy the <a href="https://gitlab.com/nhsbsa/platform-services/gitleaks/gitleaks-nhsbsa/-/raw/main/gitleaks-nhsbsa.toml" target="_blank" rel="noopener">nhsbsa-gitleaks.toml</a> config file into your project</li>
</ul>
<pre class="language-bash"><code class="language-bash"><span class="token function">wget</span> https://gitlab.com/nhsbsa/platform-services/gitleaks/gitleaks-nhsbsa/-/raw/main/gitleaks-nhsbsa.toml</code></pre>
<ul>
<li>Create a project specific <code>gitleaks.toml</code> file and configure it to extend the NHSBSA file</li>
</ul>
<pre class="language-toml"><code class="language-toml"><span class="token key property">title</span> <span class="token punctuation">=</span> <span class="token string">"&lt;project-name> gitleaks config"</span><br><br><span class="token punctuation">[</span><span class="token table class-name">extend</span><span class="token punctuation">]</span><br><span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">"gitleaks-nhsbsa.toml"</span></code></pre>
<h3 id="add-a-pre-commit-hook" tabindex="-1"><a class="header-anchor" href="#add-a-pre-commit-hook">Add a pre-commit hook</a></h3>
<ul>
<li>Install <a href="https://pre-commit.com/" target="_blank" rel="noopener">pre-commit</a></li>
<li>Install <a href="https://github.com/zricethezav/gitleaks" target="_blank" rel="noopener">Gitleaks</a></li>
<li>Add a <code>.pre-commit-config.yaml</code> configuration file:</li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">repos</span><span class="token punctuation">:</span><br><span class="token punctuation">-</span>   <span class="token key atrule">repo</span><span class="token punctuation">:</span> local<br>    <span class="token key atrule">hooks</span><span class="token punctuation">:</span><br>    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gitleaks<br>      <span class="token key atrule">name</span><span class="token punctuation">:</span> Detect hardcoded secrets<br>      <span class="token key atrule">description</span><span class="token punctuation">:</span> Detect hardcoded secrets using Gitleaks<br>      <span class="token key atrule">entry</span><span class="token punctuation">:</span> gitleaks protect <span class="token punctuation">-</span><span class="token punctuation">-</span>config="gitleaks.toml" <span class="token punctuation">-</span><span class="token punctuation">-</span>verbose <span class="token punctuation">-</span><span class="token punctuation">-</span>redact <span class="token punctuation">-</span><span class="token punctuation">-</span>staged<br>      <span class="token key atrule">language</span><span class="token punctuation">:</span> system<br>      <span class="token key atrule">pass_filenames</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>
<ul>
<li>Every contributor must install the Git hook using pre-commit:</li>
</ul>
<pre class="language-bash"><code class="language-bash">pre-commit <span class="token function">install</span></code></pre>
<h3 id="configure-gitlab-secrets-detection" tabindex="-1"><a class="header-anchor" href="#configure-gitlab-secrets-detection">Configure Gitlab secrets detection</a></h3>
<ul>
<li>Include Gitleaks secret detection job template in <code>gitlab-ci.yml</code></li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">include</span><span class="token punctuation">:</span><br>  <span class="token punctuation">-</span> <span class="token key atrule">template</span><span class="token punctuation">:</span> Security/Secret<span class="token punctuation">-</span>Detection.gitlab<span class="token punctuation">-</span>ci.yml<br><span class="token key atrule">secret_detection</span><span class="token punctuation">:</span><br>  <span class="token key atrule">variables</span><span class="token punctuation">:</span><br>    <span class="token key atrule">SECRET_DETECTION_HISTORIC_SCAN</span><span class="token punctuation">:</span> <span class="token string">"true"</span></code></pre>
<ul>
<li>Instruct secrets detection analyzer to use the project specific Gitleaks config toml file<br>
Create a file <code>.gitlab/secret-detection-ruleset.toml</code></li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>secrets<span class="token punctuation">]</span><br>description = 'secrets custom rules configuration'<br><br><span class="token punctuation">[</span><span class="token punctuation">[</span>secrets.passthrough<span class="token punctuation">]</span><span class="token punctuation">]</span><br>type  = "file"<br>target = "gitleaks.toml"<br>value = "gitleaks.toml"</code></pre>
<h3 id="ignore-false-positives" tabindex="-1"><a class="header-anchor" href="#ignore-false-positives">Ignore false positives</a></h3>
<p>Detected secrets can be ignored in different ways:</p>
<ul>
<li>
<p>Secrets in history<br>
Add the fingerprint to a <code>.gitleaksignore</code> file.</p>
</li>
<li>
<p>Uncommitted false positives<br>
Add a comment to the offending line with the <code>gitleaks:allow</code> keyword.</p>
</li>
</ul>
<p>See <a href="https://github.com/zricethezav/gitleaks" target="_blank" rel="noopener">Gitleaks README</a> for further information</p>

        <hr>
        <h2 class="nhsuk-heading-l header-anchor" id="improve-the-playbook">Improve the playbook</h2>
        <p>If you spot anything factually incorrect with this page or have ideas for improvement,
          please share your suggestions.</p>

        <p>Before you start, you will need a <a href="https://github.com/join?source=login" target="_blank" rel="noopener">GitHub account</a>.
        Github is an open forum where we collect feedback.</p>
        
<div class="nhsuk-action-link">
  <a class="nhsuk-action-link__link" href="https://github.com/nhsbsa/nhsbsa-digital-playbook/issues/new?template=playbook-proposal.md&amp;title=Change%20to%20page%20&#39;%2Fdevelopment%2Fcoding-secrets-detection&#39;%20" target="_blank" rel="noopener">
    <svg class="nhsuk-icon nhsuk-icon__arrow-right-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" width="36" height="36">
      <path d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 2a10 10 0 0 0-9.95 9h11.64L9.74 7.05a1 1 0 0 1 1.41-1.41l5.66 5.65a1 1 0 0 1 0 1.42l-5.66 5.65a1 1 0 0 1-1.41 0 1 1 0 0 1 0-1.41L13.69 13H2.05A10 10 0 1 0 12 2z"></path>
    </svg>
    <span class="nhsuk-action-link__text">Suggest a change to this page</span>
  </a>
</div>



        <div class="nhsbsa-article--date">
    <p class="nhsuk-body-s nhsuk-u-secondary-text-color nhsuk-u-margin-bottom-0">
      Published: <time datetime="2023-08-02T03:10:26.803Z">2 August 2023</time>
    </p>
</div>


        </div>
      </div>
    </div>
  </div>

    </main>
</div>

    <footer role="contentinfo">
	<div class="nhsuk-footer" id="nhsuk-footer">
		<div class="nhsuk-width-container">			<h2 class="nhsuk-u-visually-hidden">Support links</h2>
			
			<ul class="nhsuk-footer__list">				<li class="nhsuk-footer__list-item"><a class="nhsuk-footer__list-item-link" href="/nhsbsa-digital-playbook/accessibility">Accessibility</a></li>				<li class="nhsuk-footer__list-item"><a class="nhsuk-footer__list-item-link" href="https://www.nhsbsa.nhs.uk/contact-us" target="_blank" rel="noopener">Contact us</a></li>				<li class="nhsuk-footer__list-item"><a class="nhsuk-footer__list-item-link" href="https://github.com/nhsbsa/nhsbsa-digital-playbook" target="_blank" rel="noopener">GitHub</a></li>			</ul>

			<p class="nhsuk-footer__copyright">&copy; Crown copyright</p>
		</div>
	</div>

	<div class="nhsuk-ogl-footer">
		<div class="nhsuk-width-container">
			<p class="nhsuk-ogl-footer--text">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 483.2 195.7" height="17" width="41" focusable="false">
			<path fill="currentColor" d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"></path>
			</svg>
			All content is available under the <a class="nhsuk-footer__list-item-link" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="noopener" target="_blank">Open Government Licence v3.0</a>, except where otherwise stated.
			</p>
		</div>
	</div>
</footer>

    <script src="/nhsbsa-digital-playbook/javascripts/nhsuk.min.js"></script>
    <script src="/nhsbsa-digital-playbook/javascripts/application.js"></script>

</body>
</html>
